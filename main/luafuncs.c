
#include <lauxlib.h>
#include <lualib.h>
#include <lua.h>
#include <stdlib.h>
#include <stdint.h>
#include "esp_log.h"
#include "esp_timer.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "display.h"

static const char* TAG = "luafuncs";

#define LOCAL_LUA_INTEGER 1
#define LOCAL_LUA_NUMBER 2
#define LOCAL_LUA_STRING 3

//  lua_pushinteger(LUA,int);
//  lua_pushnumber(LUA,float);
//  lua_pushstring(LUA,char *);


int get_lua_arg(lua_State *LUA, int argno, int argtype, void *out) {
    int nargs = lua_gettop(LUA);
    if(argno > nargs) {
        ESP_LOGI(TAG, "Not enough args");
        return 1;
    }
    switch(argtype) {
        case LOCAL_LUA_INTEGER:
            if(!lua_isinteger(LUA,argno)){
                ESP_LOGI(TAG, "ARG %d - not an integer: %s", argno, luaL_typename(LUA,argno));
                lua_pushliteral(LUA, "bad argument");
                lua_error(LUA);
                return 1;
            }
            int *outInt = (int *)out;
            *outInt = lua_tointeger(LUA,argno);
            //ESP_LOGI(TAG, "ARG %d - %d", argno, *outInt);
        break;
        case LOCAL_LUA_NUMBER:
            if(!lua_isnumber(LUA,argno)){
                ESP_LOGI(TAG, "ARG %d - Not a number", argno);
                lua_pushliteral(LUA, "bad argument");
                lua_error(LUA);
                return 1;
            }
            float *outFloat = (float *)out;
            *outFloat = lua_tonumber(LUA,argno);
            //ESP_LOGI(TAG, "ARG %d - %g", argno, *outFloat);
        break;
        case LOCAL_LUA_STRING:
            if(!lua_isstring(LUA,argno)){
                ESP_LOGI(TAG, "ARG %d - not a string", argno);
                lua_pushliteral(LUA, "bad argument");
                lua_error(LUA);
                return 1;
            }
            char *outChar = (char *)out;
            outChar = lua_tostring(LUA,argno);
            //ESP_LOGI(TAG, "ARG %d - %s", argno, *outChar);
        break;
    }
    return 0;
}

int lua_fill_rect(lua_State *LUA) {
    int x,y,w,h,r,g,b;
    int err = 0;
    int argno = 1;
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &w);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &h);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    if(err) {
        ESP_LOGI(TAG, "FILL_RECT argument error");
    }

    fill_rect(x,y,w,h,r,g,b);
    
    return 0;
}

int lua_set_pixel(lua_State *LUA) {
    int x,y,r,g,b;
    int err = 0;
    int argno = 1;
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    if(err) {
        ESP_LOGI(TAG, "SET_PIXEL argument error");
    }

    set_pixel(x,y,r,g,b);
    
    return 0;
}

int lua_draw_hline(lua_State *LUA) {
    int x,y,len,r,g,b;
    int err = 0;
    int argno = 1;
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &len);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    if(err) {
        ESP_LOGI(TAG, "SET_PIXEL argument error");
    }

    horiz_line(x,y,len,r,g,b);
    
    return 0;
}

int lua_draw_vline(lua_State *LUA) {
    int x,y,len,r,g,b;
    int err = 0;
    int argno = 1;
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &len);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    if(err) {
        ESP_LOGI(TAG, "SET_PIXEL argument error");
    }

    vert_line(x,y,len,r,g,b);
    
    return 0;
}

int lua_clear_display(lua_State *LUA) {
    (void)LUA;
    clear_display();
    return 0;
}

// Bresenham's line algorithm
static void draw_line_impl(int x0, int y0, int x1, int y1, int r, int g, int b) {
    int dx = abs(x1 - x0);
    int dy = -abs(y1 - y0);
    int sx = x0 < x1 ? 1 : -1;
    int sy = y0 < y1 ? 1 : -1;
    int err = dx + dy;

    while (1) {
        set_pixel(x0, y0, r, g, b);
        if (x0 == x1 && y0 == y1) break;
        int e2 = 2 * err;
        if (e2 >= dy) {
            err += dy;
            x0 += sx;
        }
        if (e2 <= dx) {
            err += dx;
            y0 += sy;
        }
    }
}

int lua_draw_line(lua_State *LUA) {
    int x0, y0, x1, y1, r, g, b;
    int err = 0;
    int argno = 1;
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x0);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y0);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x1);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y1);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    if (err) {
        ESP_LOGI(TAG, "DRAW_LINE argument error");
    }

    draw_line_impl(x0, y0, x1, y1, r, g, b);
    return 0;
}

// Midpoint circle algorithm
int lua_draw_circle(lua_State *LUA) {
    int cx, cy, radius, r, g, b;
    int err = 0;
    int argno = 1;
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &cx);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &cy);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &radius);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    if (err) {
        ESP_LOGI(TAG, "DRAW_CIRCLE argument error");
    }

    int x = radius;
    int y = 0;
    int d = 1 - radius;

    while (x >= y) {
        set_pixel(cx + x, cy + y, r, g, b);
        set_pixel(cx - x, cy + y, r, g, b);
        set_pixel(cx + x, cy - y, r, g, b);
        set_pixel(cx - x, cy - y, r, g, b);
        set_pixel(cx + y, cy + x, r, g, b);
        set_pixel(cx - y, cy + x, r, g, b);
        set_pixel(cx + y, cy - x, r, g, b);
        set_pixel(cx - y, cy - x, r, g, b);

        y++;
        if (d < 0) {
            d += 2 * y + 1;
        } else {
            x--;
            d += 2 * (y - x) + 1;
        }
    }
    return 0;
}

// Filled circle using horizontal lines
int lua_draw_filled_circle(lua_State *LUA) {
    int cx, cy, radius, r, g, b;
    int err = 0;
    int argno = 1;
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &cx);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &cy);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &radius);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    if (err) {
        ESP_LOGI(TAG, "DRAW_FILLED_CIRCLE argument error");
    }

    int x = radius;
    int y = 0;
    int d = 1 - radius;

    while (x >= y) {
        horiz_line(cx - x, cy + y, 2 * x + 1, r, g, b);
        horiz_line(cx - x, cy - y, 2 * x + 1, r, g, b);
        horiz_line(cx - y, cy + x, 2 * y + 1, r, g, b);
        horiz_line(cx - y, cy - x, 2 * y + 1, r, g, b);

        y++;
        if (d < 0) {
            d += 2 * y + 1;
        } else {
            x--;
            d += 2 * (y - x) + 1;
        }
    }
    return 0;
}

// Triangle outline using three lines
int lua_draw_triangle(lua_State *LUA) {
    int x0, y0, x1, y1, x2, y2, r, g, b;
    int err = 0;
    int argno = 1;
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x0);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y0);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x1);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y1);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x2);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y2);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    if (err) {
        ESP_LOGI(TAG, "DRAW_TRIANGLE argument error");
    }

    draw_line_impl(x0, y0, x1, y1, r, g, b);
    draw_line_impl(x1, y1, x2, y2, r, g, b);
    draw_line_impl(x2, y2, x0, y0, r, g, b);
    return 0;
}

// Filled triangle using scanline algorithm
static void swap_int(int *a, int *b) {
    int t = *a; *a = *b; *b = t;
}

int lua_draw_filled_triangle(lua_State *LUA) {
    int x0, y0, x1, y1, x2, y2, r, g, b;
    int err = 0;
    int argno = 1;
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x0);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y0);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x1);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y1);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x2);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y2);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    if (err) {
        ESP_LOGI(TAG, "DRAW_FILLED_TRIANGLE argument error");
    }

    // Sort vertices by y-coordinate (y0 <= y1 <= y2)
    if (y0 > y1) { swap_int(&y0, &y1); swap_int(&x0, &x1); }
    if (y1 > y2) { swap_int(&y1, &y2); swap_int(&x1, &x2); }
    if (y0 > y1) { swap_int(&y0, &y1); swap_int(&x0, &x1); }

    if (y0 == y2) {
        // Degenerate case - horizontal line
        int minx = x0 < x1 ? (x0 < x2 ? x0 : x2) : (x1 < x2 ? x1 : x2);
        int maxx = x0 > x1 ? (x0 > x2 ? x0 : x2) : (x1 > x2 ? x1 : x2);
        horiz_line(minx, y0, maxx - minx + 1, r, g, b);
        return 0;
    }

    // Fill using horizontal lines
    for (int y = y0; y <= y2; y++) {
        int xa, xb;

        if (y < y1) {
            // Upper part of triangle
            xa = x0 + (x1 - x0) * (y - y0) / (y1 - y0);
            xb = x0 + (x2 - x0) * (y - y0) / (y2 - y0);
        } else {
            // Lower part of triangle
            if (y1 == y2) {
                xa = x1;
            } else {
                xa = x1 + (x2 - x1) * (y - y1) / (y2 - y1);
            }
            xb = x0 + (x2 - x0) * (y - y0) / (y2 - y0);
        }

        if (xa > xb) swap_int(&xa, &xb);
        horiz_line(xa, y, xb - xa + 1, r, g, b);
    }
    return 0;
}

// 3x3 bitmap font for ASCII 32-126 (minimal, best for digits)
static const uint8_t font3x3[95][3] = {
    {0x0,0x0,0x0}, // 32 (space)
    {0x2,0x2,0x2}, // 33 !
    {0x5,0x0,0x0}, // 34 "
    {0x7,0x5,0x7}, // 35 #
    {0x7,0x7,0x7}, // 36 $
    {0x1,0x2,0x4}, // 37 %
    {0x6,0x5,0x6}, // 38 &
    {0x2,0x0,0x0}, // 39 '
    {0x2,0x1,0x2}, // 40 (
    {0x2,0x4,0x2}, // 41 )
    {0x5,0x2,0x5}, // 42 *
    {0x2,0x7,0x2}, // 43 +
    {0x0,0x2,0x1}, // 44 ,
    {0x0,0x7,0x0}, // 45 -
    {0x0,0x0,0x2}, // 46 .
    {0x4,0x2,0x1}, // 47 /
    {0x7,0x5,0x7}, // 48 0
    {0x3,0x2,0x7}, // 49 1
    {0x6,0x3,0x7}, // 50 2
    {0x7,0x3,0x7}, // 51 3
    {0x5,0x7,0x4}, // 52 4
    {0x7,0x6,0x3}, // 53 5
    {0x3,0x7,0x7}, // 54 6
    {0x7,0x4,0x4}, // 55 7
    {0x7,0x7,0x7}, // 56 8
    {0x7,0x7,0x6}, // 57 9
    {0x2,0x0,0x2}, // 58 :
    {0x2,0x0,0x1}, // 59 ;
    {0x4,0x2,0x4}, // 60 <
    {0x7,0x0,0x7}, // 61 =
    {0x1,0x2,0x1}, // 62 >
    {0x6,0x2,0x2}, // 63 ?
    {0x7,0x5,0x7}, // 64 @
    {0x2,0x7,0x5}, // 65 A
    {0x3,0x7,0x7}, // 66 B
    {0x7,0x1,0x7}, // 67 C
    {0x3,0x5,0x7}, // 68 D
    {0x7,0x3,0x7}, // 69 E
    {0x7,0x3,0x1}, // 70 F
    {0x7,0x5,0x7}, // 71 G
    {0x5,0x7,0x5}, // 72 H
    {0x7,0x2,0x7}, // 73 I
    {0x4,0x4,0x7}, // 74 J
    {0x5,0x3,0x5}, // 75 K
    {0x1,0x1,0x7}, // 76 L
    {0x7,0x7,0x5}, // 77 M
    {0x7,0x5,0x5}, // 78 N
    {0x7,0x5,0x7}, // 79 O
    {0x7,0x7,0x1}, // 80 P
    {0x7,0x5,0x6}, // 81 Q
    {0x3,0x7,0x5}, // 82 R
    {0x6,0x2,0x3}, // 83 S
    {0x7,0x2,0x2}, // 84 T
    {0x5,0x5,0x7}, // 85 U
    {0x5,0x5,0x2}, // 86 V
    {0x5,0x7,0x7}, // 87 W
    {0x5,0x2,0x5}, // 88 X
    {0x5,0x2,0x2}, // 89 Y
    {0x6,0x2,0x3}, // 90 Z
    {0x6,0x2,0x6}, // 91 [
    {0x1,0x2,0x4}, // 92 backslash
    {0x3,0x2,0x3}, // 93 ]
    {0x2,0x5,0x0}, // 94 ^
    {0x0,0x0,0x7}, // 95 _
    {0x1,0x2,0x0}, // 96 `
    {0x2,0x7,0x5}, // 97 a
    {0x3,0x7,0x7}, // 98 b
    {0x7,0x1,0x7}, // 99 c
    {0x3,0x5,0x7}, // 100 d
    {0x7,0x3,0x7}, // 101 e
    {0x7,0x3,0x1}, // 102 f
    {0x7,0x5,0x7}, // 103 g
    {0x5,0x7,0x5}, // 104 h
    {0x7,0x2,0x7}, // 105 i
    {0x4,0x4,0x7}, // 106 j
    {0x5,0x3,0x5}, // 107 k
    {0x1,0x1,0x7}, // 108 l
    {0x7,0x7,0x5}, // 109 m
    {0x7,0x5,0x5}, // 110 n
    {0x7,0x5,0x7}, // 111 o
    {0x7,0x7,0x1}, // 112 p
    {0x7,0x5,0x6}, // 113 q
    {0x3,0x7,0x5}, // 114 r
    {0x6,0x2,0x3}, // 115 s
    {0x7,0x2,0x2}, // 116 t
    {0x5,0x5,0x7}, // 117 u
    {0x5,0x5,0x2}, // 118 v
    {0x5,0x7,0x7}, // 119 w
    {0x5,0x2,0x5}, // 120 x
    {0x5,0x2,0x2}, // 121 y
    {0x6,0x2,0x3}, // 122 z
    {0x6,0x2,0x6}, // 123 {
    {0x2,0x2,0x2}, // 124 |
    {0x3,0x2,0x3}, // 125 }
    {0x5,0x2,0x0}, // 126 ~
};

// 5x5 bitmap font for ASCII 32-126
static const uint8_t font5x5[95][5] = {
    {0x00,0x00,0x00,0x00,0x00}, // 32 (space)
    {0x04,0x04,0x04,0x00,0x04}, // 33 !
    {0x0A,0x0A,0x00,0x00,0x00}, // 34 "
    {0x0A,0x1F,0x0A,0x1F,0x0A}, // 35 #
    {0x0E,0x05,0x0E,0x14,0x0E}, // 36 $
    {0x11,0x08,0x04,0x02,0x11}, // 37 %
    {0x06,0x09,0x06,0x15,0x0E}, // 38 &
    {0x04,0x02,0x00,0x00,0x00}, // 39 '
    {0x08,0x04,0x04,0x04,0x08}, // 40 (
    {0x02,0x04,0x04,0x04,0x02}, // 41 )
    {0x00,0x0A,0x04,0x0A,0x00}, // 42 *
    {0x00,0x04,0x0E,0x04,0x00}, // 43 +
    {0x00,0x00,0x00,0x04,0x02}, // 44 ,
    {0x00,0x00,0x0E,0x00,0x00}, // 45 -
    {0x00,0x00,0x00,0x00,0x04}, // 46 .
    {0x10,0x08,0x04,0x02,0x01}, // 47 /
    {0x0E,0x19,0x15,0x13,0x0E}, // 48 0
    {0x04,0x06,0x04,0x04,0x0E}, // 49 1
    {0x0E,0x10,0x0E,0x01,0x1F}, // 50 2
    {0x0E,0x10,0x0C,0x10,0x0E}, // 51 3
    {0x11,0x11,0x1F,0x10,0x10}, // 52 4
    {0x1F,0x01,0x0F,0x10,0x0F}, // 53 5
    {0x0E,0x01,0x0F,0x11,0x0E}, // 54 6
    {0x1F,0x10,0x08,0x04,0x04}, // 55 7
    {0x0E,0x11,0x0E,0x11,0x0E}, // 56 8
    {0x0E,0x11,0x1E,0x10,0x0E}, // 57 9
    {0x00,0x04,0x00,0x04,0x00}, // 58 :
    {0x00,0x04,0x00,0x04,0x02}, // 59 ;
    {0x08,0x04,0x02,0x04,0x08}, // 60 <
    {0x00,0x0E,0x00,0x0E,0x00}, // 61 =
    {0x02,0x04,0x08,0x04,0x02}, // 62 >
    {0x0E,0x10,0x0C,0x00,0x04}, // 63 ?
    {0x0E,0x15,0x1D,0x01,0x0E}, // 64 @
    {0x0E,0x11,0x1F,0x11,0x11}, // 65 A
    {0x0F,0x11,0x0F,0x11,0x0F}, // 66 B
    {0x0E,0x01,0x01,0x01,0x0E}, // 67 C
    {0x0F,0x11,0x11,0x11,0x0F}, // 68 D
    {0x1F,0x01,0x0F,0x01,0x1F}, // 69 E
    {0x1F,0x01,0x0F,0x01,0x01}, // 70 F
    {0x0E,0x01,0x19,0x11,0x0E}, // 71 G
    {0x11,0x11,0x1F,0x11,0x11}, // 72 H
    {0x0E,0x04,0x04,0x04,0x0E}, // 73 I
    {0x10,0x10,0x10,0x11,0x0E}, // 74 J
    {0x11,0x09,0x07,0x09,0x11}, // 75 K
    {0x01,0x01,0x01,0x01,0x1F}, // 76 L
    {0x11,0x1B,0x15,0x11,0x11}, // 77 M
    {0x11,0x13,0x15,0x19,0x11}, // 78 N
    {0x0E,0x11,0x11,0x11,0x0E}, // 79 O
    {0x0F,0x11,0x0F,0x01,0x01}, // 80 P
    {0x0E,0x11,0x11,0x09,0x16}, // 81 Q
    {0x0F,0x11,0x0F,0x09,0x11}, // 82 R
    {0x1E,0x01,0x0E,0x10,0x0F}, // 83 S
    {0x1F,0x04,0x04,0x04,0x04}, // 84 T
    {0x11,0x11,0x11,0x11,0x0E}, // 85 U
    {0x11,0x11,0x11,0x0A,0x04}, // 86 V
    {0x11,0x11,0x15,0x1B,0x11}, // 87 W
    {0x11,0x0A,0x04,0x0A,0x11}, // 88 X
    {0x11,0x0A,0x04,0x04,0x04}, // 89 Y
    {0x1F,0x08,0x04,0x02,0x1F}, // 90 Z
    {0x0E,0x02,0x02,0x02,0x0E}, // 91 [
    {0x01,0x02,0x04,0x08,0x10}, // 92 backslash
    {0x0E,0x08,0x08,0x08,0x0E}, // 93 ]
    {0x04,0x0A,0x11,0x00,0x00}, // 94 ^
    {0x00,0x00,0x00,0x00,0x1F}, // 95 _
    {0x02,0x04,0x00,0x00,0x00}, // 96 `
    {0x00,0x0E,0x12,0x12,0x1C}, // 97 a
    {0x01,0x0F,0x11,0x11,0x0F}, // 98 b
    {0x00,0x0E,0x01,0x01,0x0E}, // 99 c
    {0x10,0x1E,0x11,0x11,0x1E}, // 100 d
    {0x00,0x0E,0x1F,0x01,0x0E}, // 101 e
    {0x0C,0x02,0x0F,0x02,0x02}, // 102 f
    {0x00,0x1E,0x11,0x1E,0x0E}, // 103 g
    {0x01,0x0F,0x11,0x11,0x11}, // 104 h
    {0x04,0x00,0x04,0x04,0x04}, // 105 i
    {0x08,0x00,0x08,0x08,0x06}, // 106 j
    {0x01,0x09,0x05,0x07,0x09}, // 107 k
    {0x06,0x04,0x04,0x04,0x0E}, // 108 l
    {0x00,0x0B,0x15,0x15,0x11}, // 109 m
    {0x00,0x0F,0x11,0x11,0x11}, // 110 n
    {0x00,0x0E,0x11,0x11,0x0E}, // 111 o
    {0x00,0x0F,0x11,0x0F,0x01}, // 112 p
    {0x00,0x1E,0x11,0x1E,0x10}, // 113 q
    {0x00,0x0D,0x13,0x01,0x01}, // 114 r
    {0x00,0x1E,0x06,0x18,0x0F}, // 115 s
    {0x02,0x0F,0x02,0x02,0x0C}, // 116 t
    {0x00,0x11,0x11,0x11,0x1E}, // 117 u
    {0x00,0x11,0x11,0x0A,0x04}, // 118 v
    {0x00,0x11,0x15,0x15,0x0A}, // 119 w
    {0x00,0x11,0x0A,0x0A,0x11}, // 120 x
    {0x00,0x11,0x1E,0x10,0x0E}, // 121 y
    {0x00,0x1F,0x08,0x02,0x1F}, // 122 z
    {0x0C,0x04,0x02,0x04,0x0C}, // 123 {
    {0x04,0x04,0x04,0x04,0x04}, // 124 |
    {0x06,0x04,0x08,0x04,0x06}, // 125 }
    {0x00,0x0D,0x12,0x00,0x00}, // 126 ~
};

// 8x8 bitmap font for ASCII 32-126
static const uint8_t font8x8[95][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // 32 (space)
    {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00}, // 33 !
    {0x36,0x36,0x00,0x00,0x00,0x00,0x00,0x00}, // 34 "
    {0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0x00}, // 35 #
    {0x0C,0x3E,0x03,0x1E,0x30,0x1F,0x0C,0x00}, // 36 $
    {0x00,0x63,0x33,0x18,0x0C,0x66,0x63,0x00}, // 37 %
    {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0x00}, // 38 &
    {0x06,0x06,0x03,0x00,0x00,0x00,0x00,0x00}, // 39 '
    {0x18,0x0C,0x06,0x06,0x06,0x0C,0x18,0x00}, // 40 (
    {0x06,0x0C,0x18,0x18,0x18,0x0C,0x06,0x00}, // 41 )
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, // 42 *
    {0x00,0x0C,0x0C,0x3F,0x0C,0x0C,0x00,0x00}, // 43 +
    {0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x06}, // 44 ,
    {0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00}, // 45 -
    {0x00,0x00,0x00,0x00,0x00,0x0C,0x0C,0x00}, // 46 .
    {0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00}, // 47 /
    {0x3E,0x63,0x73,0x7B,0x6F,0x67,0x3E,0x00}, // 48 0
    {0x0C,0x0E,0x0C,0x0C,0x0C,0x0C,0x3F,0x00}, // 49 1
    {0x1E,0x33,0x30,0x1C,0x06,0x33,0x3F,0x00}, // 50 2
    {0x1E,0x33,0x30,0x1C,0x30,0x33,0x1E,0x00}, // 51 3
    {0x38,0x3C,0x36,0x33,0x7F,0x30,0x78,0x00}, // 52 4
    {0x3F,0x03,0x1F,0x30,0x30,0x33,0x1E,0x00}, // 53 5
    {0x1C,0x06,0x03,0x1F,0x33,0x33,0x1E,0x00}, // 54 6
    {0x3F,0x33,0x30,0x18,0x0C,0x0C,0x0C,0x00}, // 55 7
    {0x1E,0x33,0x33,0x1E,0x33,0x33,0x1E,0x00}, // 56 8
    {0x1E,0x33,0x33,0x3E,0x30,0x18,0x0E,0x00}, // 57 9
    {0x00,0x0C,0x0C,0x00,0x00,0x0C,0x0C,0x00}, // 58 :
    {0x00,0x0C,0x0C,0x00,0x00,0x0C,0x0C,0x06}, // 59 ;
    {0x18,0x0C,0x06,0x03,0x06,0x0C,0x18,0x00}, // 60 <
    {0x00,0x00,0x3F,0x00,0x00,0x3F,0x00,0x00}, // 61 =
    {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00}, // 62 >
    {0x1E,0x33,0x30,0x18,0x0C,0x00,0x0C,0x00}, // 63 ?
    {0x3E,0x63,0x7B,0x7B,0x7B,0x03,0x1E,0x00}, // 64 @
    {0x0C,0x1E,0x33,0x33,0x3F,0x33,0x33,0x00}, // 65 A
    {0x3F,0x66,0x66,0x3E,0x66,0x66,0x3F,0x00}, // 66 B
    {0x3C,0x66,0x03,0x03,0x03,0x66,0x3C,0x00}, // 67 C
    {0x1F,0x36,0x66,0x66,0x66,0x36,0x1F,0x00}, // 68 D
    {0x7F,0x46,0x16,0x1E,0x16,0x46,0x7F,0x00}, // 69 E
    {0x7F,0x46,0x16,0x1E,0x16,0x06,0x0F,0x00}, // 70 F
    {0x3C,0x66,0x03,0x03,0x73,0x66,0x7C,0x00}, // 71 G
    {0x33,0x33,0x33,0x3F,0x33,0x33,0x33,0x00}, // 72 H
    {0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00}, // 73 I
    {0x78,0x30,0x30,0x30,0x33,0x33,0x1E,0x00}, // 74 J
    {0x67,0x66,0x36,0x1E,0x36,0x66,0x67,0x00}, // 75 K
    {0x0F,0x06,0x06,0x06,0x46,0x66,0x7F,0x00}, // 76 L
    {0x63,0x77,0x7F,0x7F,0x6B,0x63,0x63,0x00}, // 77 M
    {0x63,0x67,0x6F,0x7B,0x73,0x63,0x63,0x00}, // 78 N
    {0x1C,0x36,0x63,0x63,0x63,0x36,0x1C,0x00}, // 79 O
    {0x3F,0x66,0x66,0x3E,0x06,0x06,0x0F,0x00}, // 80 P
    {0x1E,0x33,0x33,0x33,0x3B,0x1E,0x38,0x00}, // 81 Q
    {0x3F,0x66,0x66,0x3E,0x36,0x66,0x67,0x00}, // 82 R
    {0x1E,0x33,0x07,0x0E,0x38,0x33,0x1E,0x00}, // 83 S
    {0x3F,0x2D,0x0C,0x0C,0x0C,0x0C,0x1E,0x00}, // 84 T
    {0x33,0x33,0x33,0x33,0x33,0x33,0x3F,0x00}, // 85 U
    {0x33,0x33,0x33,0x33,0x33,0x1E,0x0C,0x00}, // 86 V
    {0x63,0x63,0x63,0x6B,0x7F,0x77,0x63,0x00}, // 87 W
    {0x63,0x63,0x36,0x1C,0x1C,0x36,0x63,0x00}, // 88 X
    {0x33,0x33,0x33,0x1E,0x0C,0x0C,0x1E,0x00}, // 89 Y
    {0x7F,0x63,0x31,0x18,0x4C,0x66,0x7F,0x00}, // 90 Z
    {0x1E,0x06,0x06,0x06,0x06,0x06,0x1E,0x00}, // 91 [
    {0x03,0x06,0x0C,0x18,0x30,0x60,0x40,0x00}, // 92 backslash
    {0x1E,0x18,0x18,0x18,0x18,0x18,0x1E,0x00}, // 93 ]
    {0x08,0x1C,0x36,0x63,0x00,0x00,0x00,0x00}, // 94 ^
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF}, // 95 _
    {0x0C,0x0C,0x18,0x00,0x00,0x00,0x00,0x00}, // 96 `
    {0x00,0x00,0x1E,0x30,0x3E,0x33,0x6E,0x00}, // 97 a
    {0x07,0x06,0x06,0x3E,0x66,0x66,0x3B,0x00}, // 98 b
    {0x00,0x00,0x1E,0x33,0x03,0x33,0x1E,0x00}, // 99 c
    {0x38,0x30,0x30,0x3E,0x33,0x33,0x6E,0x00}, // 100 d
    {0x00,0x00,0x1E,0x33,0x3F,0x03,0x1E,0x00}, // 101 e
    {0x1C,0x36,0x06,0x0F,0x06,0x06,0x0F,0x00}, // 102 f
    {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x1F}, // 103 g
    {0x07,0x06,0x36,0x6E,0x66,0x66,0x67,0x00}, // 104 h
    {0x0C,0x00,0x0E,0x0C,0x0C,0x0C,0x1E,0x00}, // 105 i
    {0x30,0x00,0x30,0x30,0x30,0x33,0x33,0x1E}, // 106 j
    {0x07,0x06,0x66,0x36,0x1E,0x36,0x67,0x00}, // 107 k
    {0x0E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00}, // 108 l
    {0x00,0x00,0x33,0x7F,0x7F,0x6B,0x63,0x00}, // 109 m
    {0x00,0x00,0x1F,0x33,0x33,0x33,0x33,0x00}, // 110 n
    {0x00,0x00,0x1E,0x33,0x33,0x33,0x1E,0x00}, // 111 o
    {0x00,0x00,0x3B,0x66,0x66,0x3E,0x06,0x0F}, // 112 p
    {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x78}, // 113 q
    {0x00,0x00,0x3B,0x6E,0x66,0x06,0x0F,0x00}, // 114 r
    {0x00,0x00,0x3E,0x03,0x1E,0x30,0x1F,0x00}, // 115 s
    {0x08,0x0C,0x3E,0x0C,0x0C,0x2C,0x18,0x00}, // 116 t
    {0x00,0x00,0x33,0x33,0x33,0x33,0x6E,0x00}, // 117 u
    {0x00,0x00,0x33,0x33,0x33,0x1E,0x0C,0x00}, // 118 v
    {0x00,0x00,0x63,0x6B,0x7F,0x7F,0x36,0x00}, // 119 w
    {0x00,0x00,0x63,0x36,0x1C,0x36,0x63,0x00}, // 120 x
    {0x00,0x00,0x33,0x33,0x33,0x3E,0x30,0x1F}, // 121 y
    {0x00,0x00,0x3F,0x19,0x0C,0x26,0x3F,0x00}, // 122 z
    {0x38,0x0C,0x0C,0x07,0x0C,0x0C,0x38,0x00}, // 123 {
    {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00}, // 124 |
    {0x07,0x0C,0x0C,0x38,0x0C,0x0C,0x07,0x00}, // 125 }
    {0x6E,0x3B,0x00,0x00,0x00,0x00,0x00,0x00}, // 126 ~
};

// 16x16 bitmap font for ASCII 32-126
static const uint16_t font16x16[95][16] = {
    {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, // 32 (space)
    {0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0000,0x0000,0x0180,0x0180,0x0000,0x0000}, // 33 !
    {0x0660,0x0660,0x0660,0x0660,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, // 34 "
    {0x0000,0x0660,0x0660,0x1FF8,0x1FF8,0x0660,0x0660,0x0660,0x0660,0x1FF8,0x1FF8,0x0660,0x0660,0x0000,0x0000,0x0000}, // 35 #
    {0x0180,0x07E0,0x0FF0,0x1C38,0x1818,0x0018,0x00F0,0x03C0,0x0F00,0x1800,0x1818,0x1C38,0x0FF0,0x07E0,0x0180,0x0000}, // 36 $
    {0x0000,0x300C,0x300C,0x1818,0x0C30,0x0660,0x03C0,0x03C0,0x0660,0x0C30,0x1818,0x300C,0x300C,0x0000,0x0000,0x0000}, // 37 %
    {0x0000,0x01E0,0x03F0,0x0330,0x0330,0x01E0,0x00F0,0x07F8,0x0C9C,0x188C,0x1F0C,0x0F1C,0x1FF8,0x18F0,0x0000,0x0000}, // 38 &
    {0x0180,0x0180,0x0180,0x0180,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, // 39 '
    {0x0600,0x0300,0x0180,0x00C0,0x00C0,0x0060,0x0060,0x0060,0x0060,0x00C0,0x00C0,0x0180,0x0300,0x0600,0x0000,0x0000}, // 40 (
    {0x0060,0x00C0,0x0180,0x0300,0x0300,0x0600,0x0600,0x0600,0x0600,0x0300,0x0300,0x0180,0x00C0,0x0060,0x0000,0x0000}, // 41 )
    {0x0000,0x0000,0x0000,0x0660,0x03C0,0x0FF0,0x03C0,0x0660,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, // 42 *
    {0x0000,0x0000,0x0000,0x0180,0x0180,0x0180,0x1FF8,0x1FF8,0x0180,0x0180,0x0180,0x0000,0x0000,0x0000,0x0000,0x0000}, // 43 +
    {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0180,0x0180,0x0180,0x00C0,0x0000,0x0000}, // 44 ,
    {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0FF0,0x0FF0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, // 45 -
    {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0180,0x0180,0x0180,0x0000,0x0000,0x0000}, // 46 .
    {0x0000,0x1800,0x0C00,0x0C00,0x0600,0x0600,0x0300,0x0300,0x0180,0x0180,0x00C0,0x00C0,0x0060,0x0060,0x0030,0x0000}, // 47 /
    {0x0000,0x03C0,0x07E0,0x0E70,0x0C30,0x1818,0x1818,0x1818,0x1818,0x1818,0x0C30,0x0E70,0x07E0,0x03C0,0x0000,0x0000}, // 48 0
    {0x0000,0x0180,0x01C0,0x01F0,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x07E0,0x07E0,0x0000,0x0000}, // 49 1
    {0x0000,0x07E0,0x0FF0,0x1C38,0x1818,0x1800,0x0C00,0x0600,0x0300,0x0180,0x00C0,0x0060,0x1FF8,0x1FF8,0x0000,0x0000}, // 50 2
    {0x0000,0x07E0,0x0FF0,0x1C38,0x1818,0x1800,0x0F00,0x0F00,0x1800,0x1818,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 51 3
    {0x0000,0x0C00,0x0E00,0x0F00,0x0D80,0x0CC0,0x0C60,0x0C30,0x1FF8,0x1FF8,0x0C00,0x0C00,0x0C00,0x0C00,0x0000,0x0000}, // 52 4
    {0x0000,0x1FF8,0x1FF8,0x0018,0x0018,0x0FF8,0x1FF0,0x1C00,0x1800,0x1800,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 53 5
    {0x0000,0x07C0,0x0FE0,0x1C30,0x0018,0x0018,0x07F8,0x0FF8,0x1C18,0x1818,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 54 6
    {0x0000,0x1FF8,0x1FF8,0x1800,0x0C00,0x0600,0x0300,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0000,0x0000}, // 55 7
    {0x0000,0x07E0,0x0FF0,0x1C38,0x1818,0x1818,0x0FF0,0x0FF0,0x1818,0x1818,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 56 8
    {0x0000,0x07E0,0x0FF0,0x1C38,0x1818,0x1818,0x1C38,0x1FF0,0x1FE0,0x1800,0x1800,0x0C38,0x07F0,0x03E0,0x0000,0x0000}, // 57 9
    {0x0000,0x0000,0x0000,0x0180,0x0180,0x0180,0x0000,0x0000,0x0000,0x0180,0x0180,0x0180,0x0000,0x0000,0x0000,0x0000}, // 58 :
    {0x0000,0x0000,0x0000,0x0180,0x0180,0x0180,0x0000,0x0000,0x0000,0x0180,0x0180,0x0180,0x00C0,0x0000,0x0000,0x0000}, // 59 ;
    {0x0000,0x0000,0x0C00,0x0600,0x0300,0x0180,0x00C0,0x0060,0x00C0,0x0180,0x0300,0x0600,0x0C00,0x0000,0x0000,0x0000}, // 60 <
    {0x0000,0x0000,0x0000,0x0000,0x0FF0,0x0FF0,0x0000,0x0000,0x0FF0,0x0FF0,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, // 61 =
    {0x0000,0x0000,0x0030,0x0060,0x00C0,0x0180,0x0300,0x0600,0x0300,0x0180,0x00C0,0x0060,0x0030,0x0000,0x0000,0x0000}, // 62 >
    {0x0000,0x07E0,0x0FF0,0x1C38,0x1818,0x1800,0x0C00,0x0600,0x0300,0x0180,0x0000,0x0000,0x0180,0x0180,0x0000,0x0000}, // 63 ?
    {0x0000,0x07E0,0x0FF0,0x1818,0x19F8,0x1B18,0x1B18,0x1B18,0x19F0,0x0018,0x0038,0x0FF0,0x07E0,0x0000,0x0000,0x0000}, // 64 @
    {0x0000,0x03C0,0x07E0,0x0E70,0x0C30,0x1818,0x1818,0x1FF8,0x1FF8,0x1818,0x1818,0x1818,0x1818,0x1818,0x0000,0x0000}, // 65 A
    {0x0000,0x0FF8,0x1FF8,0x1818,0x1818,0x1818,0x0FF8,0x0FF8,0x1818,0x1818,0x1818,0x1818,0x1FF8,0x0FF8,0x0000,0x0000}, // 66 B
    {0x0000,0x07E0,0x0FF0,0x1C38,0x1818,0x0018,0x0018,0x0018,0x0018,0x0018,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 67 C
    {0x0000,0x03F8,0x07F8,0x0E18,0x1C18,0x1818,0x1818,0x1818,0x1818,0x1818,0x1C18,0x0E18,0x07F8,0x03F8,0x0000,0x0000}, // 68 D
    {0x0000,0x1FF8,0x1FF8,0x0018,0x0018,0x0018,0x07F8,0x07F8,0x0018,0x0018,0x0018,0x0018,0x1FF8,0x1FF8,0x0000,0x0000}, // 69 E
    {0x0000,0x1FF8,0x1FF8,0x0018,0x0018,0x0018,0x07F8,0x07F8,0x0018,0x0018,0x0018,0x0018,0x0018,0x0018,0x0000,0x0000}, // 70 F
    {0x0000,0x07E0,0x0FF0,0x1C38,0x1818,0x0018,0x0018,0x1F18,0x1F18,0x1818,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 71 G
    {0x0000,0x1818,0x1818,0x1818,0x1818,0x1818,0x1FF8,0x1FF8,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x0000,0x0000}, // 72 H
    {0x0000,0x07E0,0x07E0,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x07E0,0x07E0,0x0000,0x0000}, // 73 I
    {0x0000,0x1E00,0x1E00,0x1800,0x1800,0x1800,0x1800,0x1800,0x1818,0x1818,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 74 J
    {0x0000,0x1818,0x0C18,0x0618,0x0318,0x0198,0x00D8,0x00F8,0x0198,0x0318,0x0618,0x0C18,0x1818,0x1818,0x0000,0x0000}, // 75 K
    {0x0000,0x0018,0x0018,0x0018,0x0018,0x0018,0x0018,0x0018,0x0018,0x0018,0x0018,0x0018,0x1FF8,0x1FF8,0x0000,0x0000}, // 76 L
    {0x0000,0x1818,0x1C38,0x1E78,0x1FF8,0x1BD8,0x1998,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x0000,0x0000}, // 77 M
    {0x0000,0x1818,0x1818,0x1838,0x1878,0x18F8,0x19D8,0x1B98,0x1F18,0x1E18,0x1C18,0x1818,0x1818,0x1818,0x0000,0x0000}, // 78 N
    {0x0000,0x07E0,0x0FF0,0x1C38,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 79 O
    {0x0000,0x0FF8,0x1FF8,0x1818,0x1818,0x1818,0x1FF8,0x0FF8,0x0018,0x0018,0x0018,0x0018,0x0018,0x0018,0x0000,0x0000}, // 80 P
    {0x0000,0x07E0,0x0FF0,0x1C38,0x1818,0x1818,0x1818,0x1818,0x1818,0x19D8,0x1B98,0x1F38,0x1FF0,0x1DE0,0x0000,0x0000}, // 81 Q
    {0x0000,0x0FF8,0x1FF8,0x1818,0x1818,0x1818,0x1FF8,0x0FF8,0x0198,0x0318,0x0618,0x0C18,0x1818,0x1818,0x0000,0x0000}, // 82 R
    {0x0000,0x07E0,0x0FF0,0x1C38,0x0018,0x0018,0x00F0,0x0FC0,0x1800,0x1800,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 83 S
    {0x0000,0x1FF8,0x1FF8,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0000,0x0000}, // 84 T
    {0x0000,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x1C38,0x0FF0,0x07E0,0x0000,0x0000}, // 85 U
    {0x0000,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x0C30,0x0C30,0x0660,0x0660,0x03C0,0x03C0,0x0180,0x0000,0x0000}, // 86 V
    {0x0000,0x1818,0x1818,0x1818,0x1818,0x1818,0x1818,0x1998,0x1BD8,0x1FF8,0x1E78,0x1C38,0x1818,0x1818,0x0000,0x0000}, // 87 W
    {0x0000,0x1818,0x1818,0x0C30,0x0660,0x03C0,0x0180,0x0180,0x03C0,0x0660,0x0C30,0x1818,0x1818,0x1818,0x0000,0x0000}, // 88 X
    {0x0000,0x1818,0x1818,0x0C30,0x0660,0x03C0,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0000,0x0000}, // 89 Y
    {0x0000,0x1FF8,0x1FF8,0x1800,0x0C00,0x0600,0x0300,0x0180,0x00C0,0x0060,0x0030,0x0018,0x1FF8,0x1FF8,0x0000,0x0000}, // 90 Z
    {0x0780,0x0780,0x0060,0x0060,0x0060,0x0060,0x0060,0x0060,0x0060,0x0060,0x0060,0x0060,0x0780,0x0780,0x0000,0x0000}, // 91 [
    {0x0000,0x0018,0x0030,0x0030,0x0060,0x0060,0x00C0,0x00C0,0x0180,0x0180,0x0300,0x0300,0x0600,0x0600,0x0C00,0x0000}, // 92 backslash
    {0x01E0,0x01E0,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x01E0,0x01E0,0x0000,0x0000}, // 93 ]
    {0x0180,0x03C0,0x0660,0x0C30,0x1818,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, // 94 ^
    {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x1FF8,0x1FF8,0x0000}, // 95 _
    {0x00C0,0x0180,0x0300,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, // 96 `
    {0x0000,0x0000,0x0000,0x0000,0x07E0,0x0FF0,0x1C00,0x1FE0,0x1FF0,0x1C30,0x1830,0x1C70,0x1FE0,0x0F80,0x0000,0x0000}, // 97 a
    {0x0000,0x0030,0x0030,0x0030,0x03F0,0x07F0,0x0E30,0x1C30,0x1830,0x1830,0x1C30,0x0E30,0x07F0,0x03F0,0x0000,0x0000}, // 98 b
    {0x0000,0x0000,0x0000,0x0000,0x07C0,0x0FE0,0x1C30,0x0030,0x0030,0x0030,0x0030,0x1C30,0x0FE0,0x07C0,0x0000,0x0000}, // 99 c
    {0x0000,0x1800,0x1800,0x1800,0x1FC0,0x1FE0,0x1C30,0x1830,0x1830,0x1830,0x1830,0x1C70,0x1FE0,0x0FC0,0x0000,0x0000}, // 100 d
    {0x0000,0x0000,0x0000,0x0000,0x07C0,0x0FE0,0x1C30,0x1830,0x1FF0,0x1FF0,0x0030,0x1C30,0x0FE0,0x07C0,0x0000,0x0000}, // 101 e
    {0x0000,0x0F00,0x1F80,0x18C0,0x00C0,0x00C0,0x07F0,0x07F0,0x00C0,0x00C0,0x00C0,0x00C0,0x00C0,0x00C0,0x0000,0x0000}, // 102 f
    {0x0000,0x0000,0x0000,0x0000,0x0FC0,0x1FE0,0x1C70,0x1830,0x1830,0x1C70,0x1FE0,0x1FC0,0x1800,0x0FF0,0x07E0,0x0000}, // 103 g
    {0x0000,0x0030,0x0030,0x0030,0x07F0,0x0FF0,0x1C30,0x1830,0x1830,0x1830,0x1830,0x1830,0x1830,0x1830,0x0000,0x0000}, // 104 h
    {0x0000,0x0180,0x0180,0x0000,0x01C0,0x01C0,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x07E0,0x07E0,0x0000,0x0000}, // 105 i
    {0x0000,0x0600,0x0600,0x0000,0x0700,0x0700,0x0600,0x0600,0x0600,0x0600,0x0600,0x0630,0x07F0,0x03E0,0x0000,0x0000}, // 106 j
    {0x0000,0x0030,0x0030,0x0030,0x1830,0x0C30,0x0630,0x0330,0x01F0,0x03B0,0x0730,0x0E30,0x1C30,0x1830,0x0000,0x0000}, // 107 k
    {0x0000,0x01C0,0x01C0,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x07E0,0x07E0,0x0000,0x0000}, // 108 l
    {0x0000,0x0000,0x0000,0x0000,0x0DB8,0x1FF8,0x1E78,0x1C38,0x1C38,0x1818,0x1818,0x1818,0x1818,0x1818,0x0000,0x0000}, // 109 m
    {0x0000,0x0000,0x0000,0x0000,0x07F0,0x0FF0,0x1C30,0x1830,0x1830,0x1830,0x1830,0x1830,0x1830,0x1830,0x0000,0x0000}, // 110 n
    {0x0000,0x0000,0x0000,0x0000,0x07C0,0x0FE0,0x1C30,0x1830,0x1830,0x1830,0x1830,0x1C30,0x0FE0,0x07C0,0x0000,0x0000}, // 111 o
    {0x0000,0x0000,0x0000,0x0000,0x03F0,0x07F0,0x0E30,0x1C30,0x1830,0x1C30,0x0E30,0x07F0,0x03F0,0x0030,0x0030,0x0000}, // 112 p
    {0x0000,0x0000,0x0000,0x0000,0x1FC0,0x1FE0,0x1C30,0x1830,0x1830,0x1830,0x1C30,0x1FE0,0x1FC0,0x1800,0x1800,0x0000}, // 113 q
    {0x0000,0x0000,0x0000,0x0000,0x0DF0,0x0FF0,0x0E30,0x0C30,0x0030,0x0030,0x0030,0x0030,0x0030,0x0030,0x0000,0x0000}, // 114 r
    {0x0000,0x0000,0x0000,0x0000,0x0FC0,0x1FE0,0x0030,0x00F0,0x07C0,0x0F00,0x1800,0x1830,0x0FF0,0x07E0,0x0000,0x0000}, // 115 s
    {0x0000,0x00C0,0x00C0,0x00C0,0x07F0,0x07F0,0x00C0,0x00C0,0x00C0,0x00C0,0x00C0,0x18C0,0x1F80,0x0F00,0x0000,0x0000}, // 116 t
    {0x0000,0x0000,0x0000,0x0000,0x1830,0x1830,0x1830,0x1830,0x1830,0x1830,0x1830,0x1C70,0x1FE0,0x0FC0,0x0000,0x0000}, // 117 u
    {0x0000,0x0000,0x0000,0x0000,0x1818,0x1818,0x1818,0x0C30,0x0C30,0x0660,0x0660,0x03C0,0x03C0,0x0180,0x0000,0x0000}, // 118 v
    {0x0000,0x0000,0x0000,0x0000,0x1818,0x1818,0x1818,0x1818,0x1998,0x1BD8,0x1FF8,0x0E70,0x0C30,0x0C30,0x0000,0x0000}, // 119 w
    {0x0000,0x0000,0x0000,0x0000,0x1818,0x0C30,0x0660,0x03C0,0x0180,0x03C0,0x0660,0x0C30,0x1818,0x1818,0x0000,0x0000}, // 120 x
    {0x0000,0x0000,0x0000,0x0000,0x1830,0x1830,0x1830,0x1830,0x1C70,0x1FE0,0x1FC0,0x1800,0x0FF0,0x07E0,0x0000,0x0000}, // 121 y
    {0x0000,0x0000,0x0000,0x0000,0x1FF0,0x1FF0,0x0C00,0x0600,0x0300,0x0180,0x00C0,0x0060,0x1FF0,0x1FF0,0x0000,0x0000}, // 122 z
    {0x0E00,0x0700,0x0180,0x0180,0x0180,0x0180,0x00E0,0x00E0,0x0180,0x0180,0x0180,0x0180,0x0700,0x0E00,0x0000,0x0000}, // 123 {
    {0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0180,0x0000,0x0000}, // 124 |
    {0x0070,0x00E0,0x0180,0x0180,0x0180,0x0180,0x0700,0x0700,0x0180,0x0180,0x0180,0x0180,0x00E0,0x0070,0x0000,0x0000}, // 125 }
    {0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x18F0,0x1FF8,0x0F18,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000,0x0000}, // 126 ~
};

static void draw_char_sized(int x, int y, char c, int r, int g, int b, int size) {
    if (c < 32 || c > 126) c = '?';
    int idx = c - 32;

    if (size == 3) {
        const uint8_t *glyph = font3x3[idx];
        for (int row = 0; row < 3; row++) {
            uint8_t bits = glyph[row];
            for (int col = 0; col < 3; col++) {
                if (bits & (1 << col)) {
                    set_pixel(x + col, y + row, r, g, b);
                }
            }
        }
    } else if (size == 5) {
        const uint8_t *glyph = font5x5[idx];
        for (int row = 0; row < 5; row++) {
            uint8_t bits = glyph[row];
            for (int col = 0; col < 5; col++) {
                if (bits & (1 << col)) {
                    set_pixel(x + col, y + row, r, g, b);
                }
            }
        }
    } else if (size == 16) {
        const uint16_t *glyph = font16x16[idx];
        for (int row = 0; row < 16; row++) {
            uint16_t bits = glyph[row];
            for (int col = 0; col < 16; col++) {
                if (bits & (1 << col)) {
                    set_pixel(x + col, y + row, r, g, b);
                }
            }
        }
    } else {
        // Default to 8x8
        const uint8_t *glyph = font8x8[idx];
        for (int row = 0; row < 8; row++) {
            uint8_t bits = glyph[row];
            for (int col = 0; col < 8; col++) {
                if (bits & (1 << col)) {
                    set_pixel(x + col, y + row, r, g, b);
                }
            }
        }
    }
}

int lua_draw_string(lua_State *LUA) {
    int x, y, r, g, b, size = 8;
    int err = 0;
    int argno = 1;
    int nargs = lua_gettop(LUA);

    if (!lua_isstring(LUA, argno)) {
        ESP_LOGI(TAG, "DRAW_STRING: first arg must be string");
        lua_pushliteral(LUA, "bad argument");
        lua_error(LUA);
        return 0;
    }
    const char *str = lua_tostring(LUA, argno++);

    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &x);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &y);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &r);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &g);
    err += get_lua_arg(LUA, argno++, LOCAL_LUA_INTEGER, &b);

    // Optional font size parameter (default 8)
    if (nargs >= 7 && lua_isinteger(LUA, argno)) {
        size = lua_tointeger(LUA, argno);
        // Validate size - only allow 3, 5, 8, or 16
        if (size != 3 && size != 5 && size != 8 && size != 16) {
            size = 8;
        }
    }

    if (err) {
        ESP_LOGI(TAG, "DRAW_STRING argument error");
    }

    int cursor_x = x;
    // Add 1 pixel spacing between characters
    int char_width = (size == 3) ? 4 : (size == 5) ? 6 : (size == 16) ? 17 : 9;
    while (*str) {
        draw_char_sized(cursor_x, y, *str, r, g, b, size);
        cursor_x += char_width;
        str++;
    }
    return 0;
}

int lua_millis(lua_State *LUA) {
    uint64_t usec = (int)esp_timer_get_time();
    uint32_t millis = usec / 1000;
    lua_pushinteger(LUA,millis);
    return 1;
}

int lua_delay(lua_State *LUA) {
    int ms;
    int err = 0;
    err += get_lua_arg(LUA, 1, LOCAL_LUA_INTEGER, &ms);

    if (err) {
        ESP_LOGI(TAG, "DELAY argument error");
        return 0;
    }

    if (ms > 0) {
        vTaskDelay(pdMS_TO_TICKS(ms));
    }
    return 0;
}

void load_lua_funcs(lua_State *LUA) {
    lua_register(LUA, "clear_display", lua_clear_display);
    lua_register(LUA, "fill_rect", lua_fill_rect);
    lua_register(LUA, "draw_hline", lua_draw_hline);
    lua_register(LUA, "draw_vline", lua_draw_vline);
    lua_register(LUA, "set_pixel", lua_set_pixel);
    lua_register(LUA, "draw_line", lua_draw_line);
    lua_register(LUA, "draw_circle", lua_draw_circle);
    lua_register(LUA, "draw_filled_circle", lua_draw_filled_circle);
    lua_register(LUA, "draw_triangle", lua_draw_triangle);
    lua_register(LUA, "draw_filled_triangle", lua_draw_filled_triangle);
    lua_register(LUA, "draw_string", lua_draw_string);
    lua_register(LUA, "millis", lua_millis);
    lua_register(LUA, "delay", lua_delay);
}